<!DOCTYPE html>
<html lang="tr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fizyoterapist İlhami Yavuz | Ardahan</title>
    <meta name="description" content="Fizyoterapist İlhami Yavuz - Ardahan. Pediatrik (CME), Nörolojik ve Ortopedik Rehabilitasyon. Manuel Terapi ve Kişiye Özel Tedavi.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb', 
                            700: '#1d4ed8',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes pulse-soft {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
        }
        .animate-pulse-soft {
            animation: pulse-soft 2s infinite;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased selection:bg-primary-200 selection:text-primary-900">

    <!-- Navbar -->
    <nav id="navbar" class="fixed w-full z-50 transition-all duration-300 bg-transparent py-4">
        <div class="container mx-auto px-4 md:px-8">
            <div class="flex justify-between items-center">
                <a href="#" class="flex items-center gap-2 group">
                    <div class="bg-primary-600 text-white p-2 rounded-lg group-hover:bg-primary-700 transition-colors">
                        <i class="ph ph-activity text-2xl"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-lg font-bold leading-tight text-slate-900 navbar-text">Fzt. İlhami Yavuz</span>
                        <span class="text-xs text-primary-600 font-medium tracking-wider navbar-subtext">ARDAHAN</span>
                    </div>
                </a>

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center gap-8">
                    <a href="#home" class="text-sm font-medium hover:text-primary-600 transition-colors nav-item text-slate-600">Anasayfa</a>
                    <a href="#about" class="text-sm font-medium hover:text-primary-600 transition-colors nav-item text-slate-600">Hakkımda</a>
                    <a href="#services" class="text-sm font-medium hover:text-primary-600 transition-colors nav-item text-slate-600">Hizmetler</a>
                    <a href="#contact" class="bg-primary-600 text-white px-5 py-2.5 rounded-full text-sm font-semibold hover:bg-primary-700 transition-all shadow-lg hover:shadow-primary-600/30 flex items-center gap-2">
                        <i class="ph ph-calendar-check text-lg"></i>
                        Randevu Al
                    </a>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobile-menu-btn" class="md:hidden p-2 text-slate-700 hover:text-primary-600 transition-colors">
                    <i class="ph ph-list text-2xl"></i>
                </button>
            </div>
        </div>

        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="hidden absolute top-full left-0 w-full bg-white shadow-xl border-t border-slate-100 flex-col p-4 gap-2 md:hidden">
            <a href="#home" class="p-3 rounded-lg hover:bg-slate-50 font-medium text-slate-700">Anasayfa</a>
            <a href="#about" class="p-3 rounded-lg hover:bg-slate-50 font-medium text-slate-700">Hakkımda</a>
            <a href="#services" class="p-3 rounded-lg hover:bg-slate-50 font-medium text-slate-700">Hizmetler</a>
            <a href="#contact" class="p-3 rounded-lg bg-primary-50 text-primary-700 font-semibold mt-2 text-center">Randevu Al</a>
        </div>
    </nav>

    <!-- Hero Section -->
    <header id="home" class="relative pt-32 pb-20 md:pt-48 md:pb-32 overflow-hidden bg-slate-900">
        <div class="absolute inset-0 z-0">
            <!-- Hero Background Image -->
            <img src="https://images.unsplash.com/photo-1576091160550-2187d80a16f7?auto=format&fit=crop&q=80" alt="Rehabilitasyon Merkezi" class="w-full h-full object-cover opacity-40">
            <div class="absolute inset-0 bg-gradient-to-r from-slate-900 via-slate-900/90 to-transparent"></div>
        </div>

        <div class="container mx-auto px-4 md:px-8 relative z-10">
            <div class="max-w-3xl">
                <div class="inline-flex items-center gap-2 bg-primary-500/20 backdrop-blur-sm border border-primary-500/30 rounded-full px-4 py-1.5 mb-6">
                    <span class="w-2 h-2 rounded-full bg-primary-400 animate-pulse"></span>
                    <span class="text-primary-100 text-xs font-bold tracking-wide uppercase">Ardahan Fizyoterapi & Rehabilitasyon</span>
                </div>
                
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-6 leading-tight">
                    Hareketi Özgürleştir, <br/>
                    <span class="text-primary-500 bg-clip-text text-transparent bg-gradient-to-r from-primary-400 to-blue-600">Yaşam Kaliteni</span> Artır.
                </h1>
                
                <p class="text-lg text-slate-300 mb-10 max-w-2xl leading-relaxed">
                    Pediatrik, nörolojik ve ortopedik rehabilitasyon alanlarında bilimsel ve kanıta dayalı yaklaşımlar. Ardahan'da çocuklardan yetişkinlere uzanan bireye özel tedavi protokolleri.
                </p>
                
                <div class="flex flex-col sm:flex-row gap-4">
                    <a href="https://wa.me/905372751789" target="_blank" class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-xl font-bold transition-all shadow-lg flex items-center justify-center gap-2 group">
                        <i class="ph ph-whatsapp-logo text-xl"></i>
                        WhatsApp Danışma
                        <i class="ph ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </a>
                    <a href="#services" class="bg-white/10 hover:bg-white/20 backdrop-blur-md text-white border border-white/10 px-8 py-4 rounded-xl font-bold transition-all flex items-center justify-center">
                        Hizmetleri İncele
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- About Section -->
    <section id="about" class="py-20 bg-white">
        <div class="container mx-auto px-4 md:px-8">
            <div class="flex flex-col lg:flex-row items-center gap-12 lg:gap-20">
                <!-- Profile Image Area -->
                <div class="lg:w-1/2 relative group">
                    <div class="absolute inset-0 bg-primary-600 rounded-2xl rotate-3 opacity-10 group-hover:rotate-6 transition-transform duration-300"></div>
                    <!-- İlhami Yavuz Profil Fotoğrafı -->
                    <img 
                        src="./images/IMG-20250707-WA0011.jpg" 
                        onerror="this.onerror=null;this.src='https://placehold.co/600x800?text=Fzt.+İlhami+Yavuz'"
                        alt="Fizyoterapist İlhami Yavuz" 
                        class="relative rounded-2xl shadow-2xl w-full object-cover h-[500px] grayscale group-hover:grayscale-0 transition-all duration-500"
                    >
                    <div class="absolute bottom-6 left-6 right-6 bg-white/95 backdrop-blur p-4 rounded-xl shadow-lg border border-slate-100">
                        <div class="flex items-center gap-3">
                            <div class="bg-primary-100 p-2 rounded-lg text-primary-600">
                                <i class="ph ph-graduation-cap text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 uppercase font-bold">Fizyoterapist</p>
                                <p class="font-bold text-slate-900">İlhami Yavuz</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Area -->
                <div class="lg:w-1/2">
                    <h2 class="text-primary-600 font-bold text-sm tracking-wider uppercase mb-2">Hakkımda</h2>
                    <h3 class="text-3xl font-bold text-slate-900 mb-6">Bütüncül Yaklaşım, Fonksiyonel Sonuçlar</h3>
                    <p class="text-slate-600 mb-6 leading-relaxed">
                        Ardahan İlk Paylaşım Özel Eğitim Merkezi bünyesinde, fizyoterapi ve rehabilitasyon alanındaki akademik bilgimi saha tecrübemle birleştiriyorum. Önceliğim; semptomları baskılamak değil, **biyomekanik kaynaklı problemleri** tespit edip kalıcı çözümler üretmektir.
                    </p>
                    <p class="text-slate-600 mb-8 leading-relaxed">
                        Özellikle **Pediatrik Rehabilitasyon** (Serebral Palsi, Spina Bifida vb.) alanında Cuevas Medek (CME) gibi güncel yaklaşımları kullanırken; yetişkinlerde **Ortopedik** ve **Nörolojik** vakalarda fonksiyonel bağımsızlığı hedefleyen tedavi protokolleri uyguluyorum.
                    </p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                        <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <i class="ph ph-check-circle text-primary-600 text-xl"></i>
                            <span class="text-sm font-semibold text-slate-700">Pediatrik Uzmanlık</span>
                        </div>
                        <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <i class="ph ph-check-circle text-primary-600 text-xl"></i>
                            <span class="text-sm font-semibold text-slate-700">Manuel Terapi</span>
                        </div>
                        <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <i class="ph ph-check-circle text-primary-600 text-xl"></i>
                            <span class="text-sm font-semibold text-slate-700">Cuevas Medek (CME)</span>
                        </div>
                        <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <i class="ph ph-check-circle text-primary-600 text-xl"></i>
                            <span class="text-sm font-semibold text-slate-700">Kinezyolojik Bantlama</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Services Section -->
    <section id="services" class="py-20 bg-slate-50">
        <div class="container mx-auto px-4 md:px-8">
            <div class="text-center max-w-2xl mx-auto mb-16">
                <h2 class="text-primary-600 font-bold text-sm tracking-wider uppercase mb-2">Klinik Uygulamalar</h2>
                <h3 class="text-3xl font-bold text-slate-900">Uzmanlık Alanları</h3>
                <p class="text-slate-600 mt-4">
                    Çocuklardan yetişkinlere, her yaş grubu için özelleştirilmiş tedavi modaliteleri.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                
                <!-- Service 1: Pediatrik -->
                <div class="bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-slate-100 group overflow-hidden">
                    <div class="h-48 overflow-hidden">
                        <img src="./images/pexels-thisisengineering-3912370.jpg" alt="Pediatrik Rehabilitasyon" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                    </div>
                    <div class="p-8">
                        <h4 class="text-xl font-bold text-slate-900 mb-3 flex items-center gap-2">
                            <i class="ph ph-baby text-orange-500"></i> Pediatrik Rehab.
                        </h4>
                        <p class="text-slate-600 text-sm leading-relaxed mb-4">
                            Serebral Palsi, Spina Bifida ve gelişimsel gerilik durumlarında, motor fonksiyon kazanımı için özel terapiler.
                        </p>
                        <ul class="text-xs text-slate-500 space-y-2 border-t border-slate-100 pt-4">
                            <li class="flex items-center gap-2"><i class="ph ph-check text-orange-500"></i> Cuevas Medek Terapi (CME)</li>
                            <li class="flex items-center gap-2"><i class="ph ph-check text-orange-500"></i> Bobath Konsepti</li>
                        </ul>
                    </div>
                </div>

                <!-- Service 2: Nörolojik -->
                <div class="bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-slate-100 group overflow-hidden">
                    <div class="h-48 overflow-hidden">
                        <img src="./images/pexels-pixabay-39671.jpg" alt="Nörolojik Rehabilitasyon" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                    </div>
                    <div class="p-8">
                        <h4 class="text-xl font-bold text-slate-900 mb-3 flex items-center gap-2">
                            <i class="ph ph-brain text-blue-500"></i> Nörolojik Rehab.
                        </h4>
                        <p class="text-slate-600 text-sm leading-relaxed mb-4">
                            İnme (SVO), MS, Parkinson ve kafa travmaları sonrası nöroplastisiteyi hedefleyen, günlük yaşam aktivitelerine dönüş tedavileri.
                        </p>
                        <ul class="text-xs text-slate-500 space-y-2 border-t border-slate-100 pt-4">
                            <li class="flex items-center gap-2"><i class="ph ph-check text-blue-500"></i> Denge & Koordinasyon</li>
                            <li class="flex items-center gap-2"><i class="ph ph-check text-blue-500"></i> Yürüyüş Analizi</li>
                        </ul>
                    </div>
                </div>

                <!-- Service 3: Ortopedik -->
                <div class="bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-slate-100 group overflow-hidden">
                    <div class="h-48 overflow-hidden">
                        <img src="./images/pexels-maksgelatin-6094033.jpg" alt="Ortopedik Rehabilitasyon" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                    </div>
                    <div class="p-8">
                        <h4 class="text-xl font-bold text-slate-900 mb-3 flex items-center gap-2">
                            <i class="ph ph-person-simple-run text-green-500"></i> Ortopedik & Manuel
                        </h4>
                        <p class="text-slate-600 text-sm leading-relaxed mb-4">
                            Bel-boyun fıtığı, skolyoz, post-op rehabilitasyon ve sporcu yaralanmalarında miyofasiyal gevşetme ve mobilizasyon.
                        </p>
                        <ul class="text-xs text-slate-500 space-y-2 border-t border-slate-100 pt-4">
                            <li class="flex items-center gap-2"><i class="ph ph-check text-green-500"></i> Manuel Terapi</li>
                            <li class="flex items-center gap-2"><i class="ph ph-check text-green-500"></i> Klinik Egzersiz</li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <!-- Contact Section -->
    <section id="contact" class="py-20 bg-white">
        <div class="container mx-auto px-4 md:px-8">
            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Contact Info -->
                <div class="lg:w-1/3 bg-slate-900 text-white p-8 rounded-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-primary-500 rounded-full opacity-20 blur-xl"></div>
                    
                    <h3 class="text-2xl font-bold mb-6">İletişim</h3>
                    <p class="text-slate-400 mb-8 text-sm">
                        Değerlendirme seansı ve randevu planlaması için lütfen iletişime geçiniz.
                    </p>

                    <div class="space-y-6">
                        <div class="flex items-start gap-4">
                            <div class="bg-white/10 p-2.5 rounded-lg text-primary-400">
                                <i class="ph ph-map-pin text-xl"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-400 uppercase font-bold mb-1">Klinik Adres</p>
                                <p class="text-sm font-medium leading-relaxed">Doğu Cd No.13, Yeni Mahalle,<br>İlk Paylaşım Özel Eğitim Merkezi<br>Ardahan / Merkez</p>
                            </div>
                        </div>

                        <div class="flex items-start gap-4">
                            <div class="bg-white/10 p-2.5 rounded-lg text-primary-400">
                                <i class="ph ph-phone text-xl"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-400 uppercase font-bold mb-1">Telefon / WhatsApp</p>
                                <a href="tel:05372751789" class="text-lg font-bold hover:text-primary-400 transition-colors">0537 275 17 89</a>
                            </div>
                        </div>

                        <div class="flex items-start gap-4">
                            <div class="bg-white/10 p-2.5 rounded-lg text-primary-400">
                                <i class="ph ph-envelope text-xl"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-400 uppercase font-bold mb-1">E-Posta</p>
                                <a href="mailto:fztilhamiyavuz@gmail.com" class="text-sm hover:text-primary-400 transition-colors">fztilhamiyavuz@gmail.com</a>
                            </div>
                        </div>
                    </div>

                    <div class="mt-12 pt-8 border-t border-white/10">
                        <a href="https://www.instagram.com/fzt.ilhamiyavuz" target="_blank" class="flex items-center gap-2 text-slate-300 hover:text-white transition-colors">
                            <i class="ph ph-instagram-logo text-2xl"></i>
                            <span>@fzt.ilhamiyavuz</span>
                        </a>
                    </div>
                </div>

                <!-- Map / Form Placeholder -->
                <div class="lg:w-2/3 bg-slate-50 rounded-2xl border border-slate-100 p-2 flex items-center justify-center min-h-[400px]">
                    <div class="text-center">
                        <div class="inline-block p-4 bg-white rounded-full shadow-sm mb-4">
                            <i class="ph ph-map-trifold text-3xl text-slate-400"></i>
                        </div>
                        <h4 class="text-slate-900 font-bold mb-2">Harita Konumu</h4>
                        <p class="text-slate-500 text-sm">İlk Paylaşım Özel Eğitim Merkezi - Ardahan</p>
                        <a href="https://www.google.com/maps/search/?api=1&query=İlk+Paylaşım+Özel+Eğitim+Merkezi+Ardahan" target="_blank" class="mt-4 inline-flex items-center gap-2 text-primary-600 font-bold text-sm hover:underline">
                            Google Haritalarda Aç <i class="ph ph-arrow-square-out"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-100 py-8 text-center text-sm text-slate-500">
        <div class="container mx-auto px-4">
            <p>&copy; 2025 Fizyoterapist İlhami Yavuz. Tüm Hakları Saklıdır.</p>
        </div>
    </footer>

    <!-- Chatbot Interface -->
    <div id="chat-interface" class="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-4">
        
        <!-- Chat Window -->
        <div id="chat-window" class="hidden w-[350px] h-[500px] bg-white rounded-2xl shadow-2xl border border-slate-100 flex-col overflow-hidden transform transition-all duration-300 origin-bottom-right">
            <!-- Header -->
            <div class="bg-primary-600 p-4 flex justify-between items-center text-white">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">
                        <i class="ph ph-robot text-lg"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm">FizyoAsistan</h4>
                        <p class="text-xs text-primary-100">Yapay Zeka Destekli</p>
                    </div>
                </div>
                <button id="close-chat" class="p-1 hover:bg-white/10 rounded-lg transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <!-- Messages Area -->
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-slate-50 flex flex-col gap-3 scrollbar-hide">
                <!-- Bot Welcome Message -->
                <!-- Dynamic content loaded via JS -->
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-white border-t border-slate-100">
                <div class="flex gap-2">
                    <input type="text" id="chat-input" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:border-primary-500 transition-colors" placeholder="Sorunuzu yazın...">
                    <button id="chat-send" class="bg-primary-600 text-white p-2 rounded-xl hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="ph ph-paper-plane-right text-lg"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat Bubble Trigger -->
        <button id="chat-trigger" class="bg-primary-600 text-white p-4 rounded-full shadow-lg shadow-primary-600/30 hover:bg-primary-700 transition-all hover:scale-110 animate-pulse-soft group flex items-center gap-2">
            <i class="ph ph-chat-teardrop-text text-2xl"></i>
            <span class="max-w-0 overflow-hidden group-hover:max-w-[100px] transition-all duration-500 whitespace-nowrap font-bold text-sm">Asistana Sor</span>
        </button>
    </div>

    <!-- Firebase & Logic Script -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        // Gemini API Key (Preview Environment uses empty string and proxy)
        const apiKey = ""; 
        
        // --- UI Elements ---
        const chatTrigger = document.getElementById('chat-trigger');
        const chatWindow = document.getElementById('chat-window');
        const closeChat = document.getElementById('close-chat');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');
        const navbar = document.getElementById('navbar');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');

        // --- State ---
        let db, auth, userId;
        let isChatOpen = false;
        let isLoading = false;

        // --- UI Functions ---
        
        // Navbar Scroll Effect
        window.addEventListener('scroll', () => {
            if (window.scrollY > 20) {
                navbar.classList.add('bg-white/90', 'backdrop-blur-md', 'shadow-sm', 'py-2');
                navbar.classList.remove('py-4', 'bg-transparent');
                // Change text colors for contrast against white
                document.querySelectorAll('.navbar-text').forEach(el => el.classList.remove('text-white'));
                document.querySelectorAll('.nav-item').forEach(el => el.classList.replace('text-slate-200', 'text-slate-600'));
            } else {
                navbar.classList.remove('bg-white/90', 'backdrop-blur-md', 'shadow-sm', 'py-2');
                navbar.classList.add('py-4', 'bg-transparent');
            }
        });

        // Mobile Menu
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
            mobileMenu.classList.toggle('flex');
        });

        // Chat Toggles
        chatTrigger.addEventListener('click', () => {
            isChatOpen = true;
            chatWindow.classList.remove('hidden');
            chatWindow.classList.add('flex');
            chatTrigger.classList.add('hidden');
            initializeFirebase(); // Init on first click to save resources
            scrollToBottom();
        });

        closeChat.addEventListener('click', () => {
            isChatOpen = false;
            chatWindow.classList.add('hidden');
            chatWindow.classList.remove('flex');
            chatTrigger.classList.remove('hidden');
        });

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function appendMessage(text, sender) {
            const div = document.createElement('div');
            const isBot = sender === 'bot';
            
            div.className = `flex ${isBot ? 'justify-start' : 'justify-end'} animate-fade-in`;
            
            div.innerHTML = `
                <div class="max-w-[80%] p-3 rounded-2xl text-sm ${
                    isBot 
                    ? 'bg-white text-slate-700 border border-slate-100 rounded-tl-none shadow-sm' 
                    : 'bg-primary-600 text-white rounded-tr-none shadow-md'
                }">
                    ${text}
                </div>
            `;
            
            chatMessages.appendChild(div);
            scrollToBottom();
        }

        function showTypingIndicator() {
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'flex justify-start';
            div.innerHTML = `
                <div class="bg-white border border-slate-100 p-3 rounded-2xl rounded-tl-none shadow-sm flex gap-1">
                    <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></span>
                    <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                    <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                </div>
            `;
            chatMessages.appendChild(div);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const el = document.getElementById('typing-indicator');
            if (el) el.remove();
        }

        // --- Logic ---

        async function initializeFirebase() {
            if (db) return; // Already initialized

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Auth Logic
                const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (initialToken) {
                    await signInWithCustomToken(auth, initialToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        loadChatHistory();
                    }
                });

            } catch (e) {
                console.error("Firebase Init Error:", e);
                appendMessage("Bağlantı hatası oluştu. Lütfen sayfayı yenileyin.", "bot");
            }
        }

        function loadChatHistory() {
            if (!userId || !db) return;

            // Listen to messages
            const q = query(
                collection(db, `artifacts/${appId}/users/${userId}/messages`), 
                orderBy('timestamp', 'asc')
            );

            onSnapshot(q, (snapshot) => {
                // Only process changes if needed, but for simplicity we assume local append handles immediate feedback
                // Real implementation would sync here. 
                // For this demo, we just show welcome if empty.
                if (snapshot.empty && chatMessages.children.length === 0) {
                     appendMessage("Merhaba! Ben İlhami Hocam'ın dijital asistanı FizyoAsistan. Fizyoterapi, rehabilitasyon süreçleri veya randevu hakkında sorularınızı cevaplayabilirim.", "bot");
                }
            }, (error) => {
                console.error("Snapshot Error:", error);
            });
        }

        async function handleSend() {
            const text = chatInput.value.trim();
            if (!text || isLoading) return;

            // UI Updates
            chatInput.value = '';
            appendMessage(text, 'user');
            isLoading = true;
            chatSend.disabled = true;
            showTypingIndicator();

            try {
                // 1. Save User Message to Firestore
                if (userId && db) {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/messages`), {
                        role: 'user',
                        content: text,
                        timestamp: serverTimestamp()
                    });
                }

                // 2. Call Gemini API
                const systemPrompt = `Sen Fizyoterapist İlhami Yavuz'un profesyonel dijital asistanı FizyoAsistan'sın. 
                                      İlhami Hocamız Ardahan'da, "İlk Paylaşım Özel Eğitim Merkezi"nde çalışmaktadır.
                                      Kullanıcıya genel fizyoterapi (Pediatrik, Nörolojik, Ortopedik) bilgileri sağla.
                                      Asla kesin tıbbi teşhis koyma. "En doğru değerlendirme için İlhami Hocamıza klinik ortamında muayene olmanız gerekir" uyarısını yap.
                                      İlhami Hocamızın telefon numarası: 05372751789. Bu numarayı sadece iletişim sorulursa ver.
                                      Teknik terimler (propriosepsiyon, spastisite, mobilizasyon vb.) kullanmaktan çekinme ama açıkla.`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                const data = await response.json();
                const botReply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Şu an cevap veremiyorum, lütfen randevu için arayınız.";

                // 3. UI Update with Bot Reply
                removeTypingIndicator();
                appendMessage(botReply, 'bot');

                // 4. Save Bot Reply to Firestore
                if (userId && db) {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/messages`), {
                        role: 'model',
                        content: botReply,
                        timestamp: serverTimestamp()
                    });
                }

            } catch (error) {
                console.error(error);
                removeTypingIndicator();
                appendMessage("Bir hata oluştu. Lütfen 0537 275 17 89 numarasından ulaşınız.", "bot");
            } finally {
                isLoading = false;
                chatSend.disabled = false;
                chatInput.focus();
            }
        }

        // Event Listeners
        chatSend.addEventListener('click', handleSend);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSend();
        });

    </script>
</body>
</html>


